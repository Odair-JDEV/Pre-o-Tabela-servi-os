<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<title>Planos e ServiÃ§os - Corrigido</title>
<style>
  body{font-family: Arial, Helvetica, sans-serif;background:#f5f7f9;margin:0;padding:20px}
  header{background:#175fa0;color:#fff;padding:18px;border-radius:8px}
  h1{margin:0}
  .box{background:#fff;border-radius:10px;padding:18px;margin:18px auto;max-width:900px;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
  h2{color:#175fa0;border-bottom:2px solid #e6eef8;padding-bottom:6px}
  .item{padding:12px;border-bottom:1px solid #eee}
  .item strong{display:block;color:#0b3b66;margin-bottom:6px}
  .preco{color:#333}
  .error{color:#b91c1c;font-weight:700;padding:10px;border-radius:6px;background:#fdecea}
  .btn{background:#0891b2;color:#fff;padding:8px 12px;border:0;border-radius:6px;cursor:pointer}
</style>
</head>
<body>
<header class="box">
  <h1>Planos e ServiÃ§os</h1>
  <small>Fonte: Google Sheets (CSV publicado)</small>
  <div style="margin-top:10px">
    <button class="btn" onclick="carregarCSV()">Atualizar agora</button>
    <span id="last" style="margin-left:12px;color:#333"></span>
  </div>
</header>

<div id="saida" class="box">Carregando...</div>

<script>
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQiJKegPY4bCrxIoKZ474PblFGF8mPHQWBNldXFobO36GitnPw3wuyDT_65YYp2HwBCFZ2FnViKtYwo/pub?gid=0&single=true&output=csv";

/** Parse CSV que respeita aspas e vÃ­rgulas */
function parseCSV(text) {
  const rows = [];
  let cur = "", row = [], inQuotes = false;
  for (let i = 0; i < text.length; i++) {
    const ch = text[i], nxt = text[i+1];
    if (ch === '"') {
      if (inQuotes && nxt === '"') { cur += '"'; i++; }
      else inQuotes = !inQuotes;
    } else if (ch === ',' && !inQuotes) {
      row.push(cur); cur = "";
    } else if ((ch === '\n' || ch === '\r') && !inQuotes) {
      if (ch === '\r' && nxt === '\n') i++;
      row.push(cur); rows.push(row);
      row = []; cur = "";
    } else {
      cur += ch;
    }
  }
  if (cur !== "" || row.length > 0) { row.push(cur); rows.push(row); }
  return rows.map(r => r.map(c => (c||"").trim()));
}

/** Normaliza valores: remove R$, troca vÃ­rgula por ponto e converte */
function normalizarValor(texto) {
  if (!texto) return null;
  const t = texto.toString().trim();
  if (t === "" || t.toLowerCase().includes("s/cart")) return null;
  const limpo = t.replace(/[R$\s]/g, "").replace(".", "").replace(",", ".");
  const num = parseFloat(limpo);
  return isNaN(num) ? null : num;
}

/** Formata como moeda BRL */
function formatarMoeda(v) {
  if (v === null) return "s/cartÃ£o";
  return v.toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
}

async function carregarCSV() {
  const el = document.getElementById("saida");
  el.innerHTML = "Carregando...";
  try {
    const resp = await fetch(CSV_URL);
    if (!resp.ok) throw new Error("Falha ao buscar CSV");
    const text = await resp.text();
    const rows = parseCSV(text);

    // Planos A3:C13 -> slice(2,13)
    const planos = rows.slice(2, 13);
    // ServiÃ§os A17:C29 -> slice(16,29)
    const servicos = rows.slice(16, 29);

    let html = "<h2>Planos de Internet</h2>";
    planos.forEach(r => {
      const nome = r[0] || "";
      const cart = normalizarValor(r[1]);
      const bol = normalizarValor(r[2]);
      if (!nome) return;
      html += `<div class="item">
        <strong>${nome}</strong>
        <div class="preco">ðŸ’³ CartÃ£o: ${formatarMoeda(cart)}</div>
        <div class="preco">ðŸ“„ Boleto: ${formatarMoeda(bol)}</div>
      </div>`;
    });

    html += "<h2>ServiÃ§os Digitais</h2>";
    servicos.forEach(r => {
      const nome = r[0] || "";
      const cart = normalizarValor(r[1]);
      const bol = normalizarValor(r[2]);
      if (!nome) return;
      html += `<div class="item">
        <strong>${nome}</strong>
        <div class="preco">ðŸ’³ CartÃ£o: ${formatarMoeda(cart)}</div>
        <div class="preco">ðŸ“„ Boleto: ${formatarMoeda(bol)}</div>
      </div>`;
    });

    el.innerHTML = html;
    document.getElementById("last").textContent = "Ãšltima atualizaÃ§Ã£o: " + new Date().toLocaleString("pt-BR");

  } catch (err) {
    el.innerHTML = `<div class="error">Erro: ${err.message}</div>`;
  }
}

carregarCSV();
</script>
</body>
</html>
